name: CI Build

on:
  push:
    branches: [ main, develop ]
    paths-ignore:
      - '**.md'
  pull_request:
    branches: [ main, develop ]
    paths-ignore:
      - '**.md'
  workflow_dispatch:

env:
  GRADLE_OPTS: -Dorg.gradle.daemon=false -Dorg.gradle.parallel=true -Dorg.gradle.caching=true

jobs:
  build-core:
    name: Build Core Module
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Set up JDK 25
      uses: actions/setup-java@v4
      with:
        java-version: '25'
        distribution: 'temurin'
        cache: gradle
        
    - name: Grant execute permission for gradlew
      run: chmod +x gradlew
      
    - name: Build core module
      run: ./gradlew :core:build --no-daemon --stacktrace
      
    - name: Upload core build artifacts
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: core-build-artifacts
        path: core/build/libs/
        retention-days: 7

  build-desktop:
    name: Build Desktop App
    runs-on: ubuntu-latest
    needs: build-core
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Set up JDK 25
      uses: actions/setup-java@v4
      with:
        java-version: '25'
        distribution: 'temurin'
        cache: gradle
        
    - name: Grant execute permission for gradlew
      run: chmod +x gradlew
      
    - name: Build desktop app
      run: ./gradlew :app-desktop:build --no-daemon --stacktrace
      
    - name: Upload desktop build artifacts
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: desktop-build-artifacts
        path: app-desktop/build/libs/
        retention-days: 7

  test:
    name: Run Tests
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Set up JDK 25
      uses: actions/setup-java@v4
      with:
        java-version: '25'
        distribution: 'temurin'
        cache: gradle
        
    - name: Grant execute permission for gradlew
      run: chmod +x gradlew
      
    - name: Run all tests
      run: ./gradlew test --no-daemon --stacktrace
      
    - name: Upload test results
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: test-results
        path: |
          **/build/test-results/
          **/build/reports/tests/
        retention-days: 7

  package-desktop:
    name: Package Desktop Distribution
    runs-on: ${{ matrix.os }}
    needs: build-desktop
    if: github.ref == 'refs/heads/main'
    strategy:
      matrix:
        os: [ubuntu-latest, macos-latest, windows-latest]
        
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Set up JDK 25
      uses: actions/setup-java@v4
      with:
        java-version: '25'
        distribution: 'temurin'
        cache: gradle
        
    - name: Grant execute permission for gradlew (Unix)
      if: runner.os != 'Windows'
      run: chmod +x gradlew
      
    - name: Package for current OS
      run: ./gradlew :app-desktop:packageDistributionForCurrentOS --no-daemon --stacktrace
      
    - name: Upload distribution packages
      uses: actions/upload-artifact@v4
      with:
        name: desktop-packages-${{ matrix.os }}
        path: app-desktop/build/compose/binaries/main/*/
        retention-days: 7

  code-quality:
    name: Code Quality Checks
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Set up JDK 25
      uses: actions/setup-java@v4
      with:
        java-version: '25'
        distribution: 'temurin'
        cache: gradle
        
    - name: Grant execute permission for gradlew
      run: chmod +x gradlew
      
    - name: Run detekt (if configured)
      run: ./gradlew detekt --no-daemon --stacktrace || echo "Detekt not configured"
      continue-on-error: true
      
    - name: Check code formatting
      run: ./gradlew ktlintCheck --no-daemon --stacktrace || echo "ktlint not configured"
      continue-on-error: true

  build-status:
    name: Build Status
    runs-on: ubuntu-latest
    needs: [build-core, build-desktop, test]
    if: always()
    
    steps:
    - name: Check build status
      run: |
        if [ "${{ needs.build-core.result }}" != "success" ] || \
           [ "${{ needs.build-desktop.result }}" != "success" ] || \
           [ "${{ needs.test.result }}" != "success" ]; then
          echo "Build or tests failed"
          exit 1
        else
          echo "All builds and tests passed"
        fi
